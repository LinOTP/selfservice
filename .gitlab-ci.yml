include:
  - project: "dev/ext-project-packaging/ci-includes"
    file: "linotp-container-ci.yml"
  - project: "dev/ext-project-packaging/ci-includes"
    file: "node-projects/test.yml"

variables:
  LANG: C.UTF-8
  REGISTRY_IMAGE_NAME: linotp/selfservice

cache:
  paths:
    - node_modules

stages:
  - test
  - build
  - upload

# Overwrite docker build job
build-image:
  script:
    - apk add jq
    - IMAGE_VERSION=$(jq --raw-output '."version"' <package.json | tr -d A-Za-z | tr -- -_ .)
    - DATE=$(date +"%Y%m%d")
    - docker build
      --build-arg=NPM_CI_TOKEN=$NPM_CI_TOKEN
      --label de.linotp.commit-ref="$CI_COMMIT_REF_NAME"
      --label de.linotp.commit-hash="$CI_COMMIT_SHORT_SHA"
      --label de.linotp.image-tag="$IMAGE_VERSION-$DATE"
      --label de.linotp.version="$IMAGE_VERSION"
      -t "$BUILD_IMAGE_TAG"  .
    - docker push "$BUILD_IMAGE_TAG"
