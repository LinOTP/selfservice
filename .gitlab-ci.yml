include:
  - project: "dev/ext-project-packaging/ci-includes"
    file: "linotp-container-ci.yml"
  - project: "dev/ext-project-packaging/ci-includes"
    file: "node-projects/test.yml"

variables:
  LANG: C.UTF-8
  REGISTRY_IMAGE_NAME: linotp/selfservice

cache:
  paths:
    - node_modules

stages:
  - test
  - build
  - test-docker
  - upload

# Overwrite docker build job
build-image:
  script:
    - apk add jq
    - IMAGE_VERSION=$(jq --raw-output '."version"' <package.json | tr -d A-Za-z | tr -- -_ .)
    - DATE=$(date +"%Y%m%d")
    - docker buildx build
      --provenance false
      --build-arg=NPM_CI_TOKEN=$NPM_CI_TOKEN
      --label de.linotp.commit-ref="$CI_COMMIT_REF_NAME"
      --label de.linotp.commit-hash="$CI_COMMIT_SHORT_SHA"
      --label de.linotp.image-tag="$IMAGE_VERSION-$DATE"
      --label de.linotp.version="$IMAGE_VERSION"
      -t "$BUILD_IMAGE_TAG"  .
    - docker push "$BUILD_IMAGE_TAG"

# Test Docker container routes
test-docker-routes:
  stage: test-docker
  image: alpine:latest
  services:
    - name: $BUILD_IMAGE_TAG
      alias: selfservice
  variables:
    FF_NETWORK_PER_BUILD: "true"
  before_script:
    - apk add -q curl
    - sleep 5
  script:
    - echo "Testing language redirects and content..."

    # Test English redirect
    - REDIRECT=$(curl -fsS -I -H "Accept-Language:en" http://selfservice:8000/selfservice/)
    - echo "$REDIRECT" | grep -q "302"
    - echo "$REDIRECT" | grep -q "/selfservice/en/"

    # Test German redirect
    - REDIRECT=$(curl -fsS -I -H "Accept-Language:de" http://selfservice:8000/selfservice/)
    - echo "$REDIRECT" | grep -q "302"
    - echo "$REDIRECT" | grep -q "/selfservice/de/"

    # Test English page
    - STATUS=$(curl -fsS -L -o /dev/null -w '%{http_code}' http://selfservice:8000/selfservice/en/)
    - test "$STATUS" = "200"
    - CONTENT=$(curl -fsS http://selfservice:8000/selfservice/en/)
    - echo "$CONTENT" | grep -q '<html lang="en"'
    - echo "$CONTENT" | grep -q '<base href="/selfservice/en/">'

    # Test German page
    - STATUS=$(curl -fsS -L -o /dev/null -w '%{http_code}' http://selfservice:8000/selfservice/de/)
    - test "$STATUS" = "200"
    - CONTENT=$(curl -fsS http://selfservice:8000/selfservice/de/)
    - echo "$CONTENT" | grep -q '<html lang="de"'
    - echo "$CONTENT" | grep -q '<base href="/selfservice/de/">'

    - echo "âœ… All route tests passed!"
  needs:
    - build-image
