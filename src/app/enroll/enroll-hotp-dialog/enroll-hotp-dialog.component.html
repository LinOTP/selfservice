<mat-horizontal-stepper [linear]="true" linear #stepper>

  <mat-step [stepControl]="enrollmentStep" id="stepDescription">
    <p>
      You have chosen to enroll an event-based soft token.
    </p>
    <p>
      You need an OATH compatible soft token app installed on your mobile device to use this kind of token, such as:
    </p>
    <ul>
      <li>FreeOTP</li>
      <li>Google Authenticator</li>
    </ul>
    <p>
      If you are not sure whether your app is compatible, you will later have the possibility to test the token. Should the test
      fail, you can install another app and try again.
    </p>
    <p>
      Once you have an app installed on your device, you can set a description for your new token and start the enrollment process:
    </p>
    <form [formGroup]="enrollmentForm">
      <mat-form-field>
        <input matInput placeholder="Token description" formControlName="description" autofocus>
        <mat-error>
          The token description is required. It should help you identify the token at a later point. It could, for example, refer to
          its usage scenario.
        </mat-error>
        <mat-hint>
          The token description should help you identify the token at a later point. It could, for example, refer to its usage scenario.
        </mat-hint>
      </mat-form-field>
    </form>
    <mat-dialog-actions align="end">
      <div>Step {{currentStep}} of {{maxSteps}}</div>
      <span class="spacer"></span>
      <button mat-raised-button (click)="cancelDialog()">Cancel</button>
      <button mat-raised-button color="primary" [disabled]="enrollmentForm.invalid" (click)="goToTokenInfo(stepper)" id="goTo2">Next</button>
    </mat-dialog-actions>
   </mat-step>
  <mat-step active="false" id="stepShowQR">
    <div *ngIf="enrolledToken">
      <p>
        A token with the serial number {{enrolledToken.serial}} (description: {{ enrollmentForm.get('description').value}}) has been
        enrolled.
      </p>
      <p>
        Scan the QR code below with your soft token app or
        <a [href]="enrolledToken.url">follow this link</a>
        to install it on your mobile device.</p>
      <ngx-qrcode qrc-element-type="url" [qrc-value]="enrolledToken.url"></ngx-qrcode>
    </div>
    <p>
      Follow the instructions on your app to install the soft token profile.
    </p>
    <mat-dialog-actions align="end">
      <div>Step {{currentStep}} of {{maxSteps}}</div>
      <span class="spacer"></span>
      <button mat-raised-button (click)="cancelDialog()">Cancel</button>
      <button mat-raised-button color="primary" (click)="incrementStep(stepper)">Next</button>
    </mat-dialog-actions>
  </mat-step>

  <mat-step active="false" optional="true" id="stepPIN">
    <p>
      We recommend you to set a security PIN now:
      <br/>
      <button mat-raised-button color="primary" (click)="setPin()">Set pin</button>
    </p>
    <p class="mat-hint hint">
      Setting a PIN helps you protect your token against misuse.
    </p>
    <mat-dialog-actions align="end">
      <div>Step {{currentStep}} of {{maxSteps}}</div>
      <span class="spacer"></span>
      <button mat-raised-button (click)="cancelDialog()">Cancel</button>
      <button mat-raised-button color="primary" (click)="incrementStep(stepper)">Next</button>
    </mat-dialog-actions>
  </mat-step>

  <mat-step active="false" id="stepTest">
    <div *ngIf="!testSuccessful">
      <p>
        To finalize, we will verify if your token is correctly enrolled via a test authentication.
      </p>
      <p>
        Generate a OTP on your app, and enter the value below. If you are using FreeOTP, skip the first OTP and enter the second
        one.
      </p>
      <p *ngIf="pinSet">
        Finally, enter the PIN you have set in the previous step.
      </p>
      <form [formGroup]="testStep" class="testOTP">
        <mat-form-field>
          <input matInput placeholder="Test OTP" formControlName="otp" autocomplete="new-password" autofocus>
        </mat-form-field>
        <mat-form-field *ngIf="pinSet">
          <input matInput placeholder="Token PIN" type="password" formControlName="pin" autocomplete="new-password">
        </mat-form-field>
        <button matLine mat-raised-button color="primary" type="submit" (click)="testToken()" [disabled]="testStep.invalid">Submit</button>
        <p *ngIf="testFailed" class="warning">
          Authentication failed. Check if both the OTP and the PIN are correct.
        </p>
      </form>
      <mat-dialog-actions align="end" *ngIf="!testFailed">
        <div>Step {{currentStep}} of {{maxSteps}}</div>
        <span class="spacer"></span>
        <button mat-raised-button (click)="cancelDialog()">Cancel</button>
      </mat-dialog-actions>
    </div>
    <div *ngIf="testFailed">
      <p>
        If verification is always failing or nothing happens, contact your administrator or go back to try a different app:
      </p>
      <mat-dialog-actions align="end">
        <div>Step {{currentStep}} of {{maxSteps}}</div>
        <span class="spacer"></span>
        <button mat-raised-button (click)="cancelDialog()">Cancel</button>
        <button mat-raised-button color="primary" (click)="goToAppStep(stepper)">Try to create the token again</button>
      </mat-dialog-actions>
    </div>
    <div *ngIf="testSuccessful">
      <p>
        Test successful. You can now use your event-based soft token to authenticate.
      </p>
      <mat-dialog-actions align="end">
        <div>Step {{currentStep}} of {{maxSteps}}</div>
        <span class="spacer"></span>
        <button mat-raised-button color="primary" (click)="closeDialog()">Close dialog</button>
      </mat-dialog-actions>
    </div>
  </mat-step>
</mat-horizontal-stepper>
