<h2 mat-dialog-title
    i18n>Add {{ this.tokenDisplayData.name }}</h2>
<mat-horizontal-stepper [linear]="true"
                        responsiveOrientation
                        class="flex-grow-1">
  <mat-step [completed]="false"
            [editable]="false"
            label="Create token"
            i18n-label>
    <ng-template matStepLabel
                 i18n>Create token</ng-template>
    <mat-dialog-content>
      <h3 class="cdk-visually-hidden"
          i18n>Create token</h3>
      <p i18n="@@smsStepperCreateInstruction">Pair a new token with your mobile phone number to receive OTPs for
        authentication.</p>
      <p *ngIf="!canEditPhone && userPhone"
         i18n>The token will use your user mobile number: <b>{{ userPhone }}</b></p>
      <p *ngIf="!canEditPhone && !userPhone"
         class="warning"
         i18n>
        You have no mobile number assigned to your user account and the token will therefore not work after creation.
        You may need to contact your administrator for help.
      </p>
      <form [formGroup]="createTokenForm"
            (keydown.enter)="enrollSMSToken()">
        <mat-form-field *ngIf="canEditPhone"
                        appSubscriptAriaLive>
          <mat-label i18n>Mobile phone number</mat-label>
          <input matInput
                 formControlName="phoneNumber"
                 appFocusOnInit
                 [attr.aria-invalid]="createTokenForm.get('phoneNumber')?.invalid && createTokenForm.get('phoneNumber')?.touched">
          <mat-hint *ngIf="canEditPhone"
                    i18n>Set the mobile phone number to use for your token</mat-hint>
          <mat-error i18n
                     *ngIf="createTokenForm.get('phoneNumber').hasError('required')">
            Mobile phone number is required.
          </mat-error>
        </mat-form-field>
        <app-create-token-step [form]="createTokenForm"></app-create-token-step>
      </form>
    </mat-dialog-content>
  </mat-step>
  <ng-template #createTokenStepActions>
    <app-step-actions [awaitingResponse]="awaitingResponse"
                      [disableSubmit]="createTokenForm.invalid || awaitingResponse"
                      (cancelled)="close()"
                      (submitted)="enrollSMSToken()">
    </app-step-actions>
  </ng-template>


  <mat-step *ngIf="verifyPolicyEnabled"
            label="Verify"
            i18n-label>
    <ng-template matStepLabel
                 i18n>Verify</ng-template>
    <mat-dialog-content>
      <h3 class="cdk-visually-hidden"
          i18n>Verify</h3>
      <app-verify-token [token]="enrolledToken"
                        (tokenVerified)="isTokenVerified = true; goToNextStep(stepper)"></app-verify-token>
    </mat-dialog-content>
  </mat-step>
  <ng-template #verifyTokenStepActions>
    <app-step-actions [awaitingResponse]="undefined"
                      [disableSubmit]="!isTokenVerified"
                      (cancelled)="cancel()"
                      (submitted)="goToNextStep(stepper)">
    </app-step-actions>
  </ng-template>

  <mat-step label="Done"
            i18n-label>
    <ng-template matStepLabel
                 i18n>Done</ng-template>
    <ng-template matStepContent>
      <mat-dialog-content>
        <h3 class="cdk-visually-hidden"
            i18n>Done</h3>
        <app-done-step [token]="enrolledToken"></app-done-step>
      </mat-dialog-content>
    </ng-template>
  </mat-step>

  <ng-template #doneStepActions>
    <app-step-actions [disableSubmit]="false"
                      [isDoneStep]="true"
                      (submitted)="close()"></app-step-actions>
  </ng-template>
</mat-horizontal-stepper>

<mat-dialog-actions align="end">
  <ng-container *ngTemplateOutlet="
        (verifyPolicyEnabled ?
        [createTokenStepActions, verifyTokenStepActions, doneStepActions] :
        [createTokenStepActions, doneStepActions])
        [stepper.selectedIndex]"></ng-container>
</mat-dialog-actions>